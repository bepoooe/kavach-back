(()=>{"use strict";class e{static calculateScore(e,t=[]){let a=100;return a-=Math.min(5*e.length,40),a-=3*e.filter((e=>["advertising","social","analytics"].includes(e.category))).length,a-=Math.min(8*t.length,30),Math.max(0,Math.min(100,a))}}const t={"doubleclick.net":{category:"advertising",name:"Google DoubleClick"},"googletagmanager.com":{category:"analytics",name:"Google Tag Manager"},"facebook.com":{category:"social",name:"Facebook Pixel"},"google-analytics.com":{category:"analytics",name:"Google Analytics"},"connect.facebook.net":{category:"social",name:"Facebook Connect"},"amazon-adsystem.com":{category:"advertising",name:"Amazon Advertising"},"twitter.com":{category:"social",name:"Twitter Analytics"},"linkedin.com":{category:"social",name:"LinkedIn Insights"}};function a(e){return new Promise((t=>{let a=0;const s=setInterval((()=>{a++,window.FingerprintJS?(clearInterval(s),async function(){try{const a=await window.FingerprintJS.load({apiKey:e,region:"ap"}),s=await a.get({extendedResult:!0});t({success:!0,data:{visitorId:s.visitorId,confidence:s.confidence,components:s.components,requestId:s.requestId,timestamp:Date.now()}})}catch(e){t({success:!1,error:`Fingerprinting failed: ${e.message}`})}}()):a>50&&(clearInterval(s),t({success:!1,error:"FingerprintJS object not found after script injection."}))}),100)}))}new class{constructor(){this.siteData=new Map,this.blockedRequests=new Map,this.privacyPolicyUrls=new Map,console.log("üöÄ Kavach Background Service starting..."),this.setupRequestBlocking(),this.setupTabListeners(),this.setupMessageListeners(),console.log("‚úÖ Kavach Background Service initialized")}safeParseURL(e){try{return e&&"string"==typeof e?new URL(e):(console.warn("‚ùå Invalid URL input:",e),null)}catch(t){return console.warn("‚ùå Failed to parse URL:",e,t),null}}getDomainFromURL(e){const t=this.safeParseURL(e);return t?t.hostname:null}setupRequestBlocking(){console.log("üõ°Ô∏è Kavach: Setting up request blocking..."),chrome.webRequest.onBeforeRequest.addListener((e=>{if(console.log("üåê Request detected:",e.url,"Type:",e.type,"Initiator:",e.initiator),"main_frame"===e.type)return{};const t=this.safeParseURL(e.url),a=e.initiator?this.safeParseURL(e.initiator):null;return t&&a&&t.hostname!==a.hostname&&(console.log("üö® Third-party request:",t.hostname,"from",a.hostname),this.trackThirdPartyRequest(a.hostname,t.hostname,e.type)),{}}),{urls:["<all_urls>"]},["requestBody"])}setupTabListeners(){console.log("üëÇ Setting up tab listeners..."),chrome.tabs.onUpdated.addListener(((e,t,a)=>{"complete"===t.status&&a.url&&this.isValidHttpUrl(a.url)&&(console.log("üìÑ Tab completed loading:",a.url),this.initializeSiteData(a.url))})),chrome.tabs.onActivated.addListener((async e=>{try{const t=await chrome.tabs.get(e.tabId);t.url&&this.isValidHttpUrl(t.url)&&(console.log("üîÑ Tab activated:",t.url),this.initializeSiteData(t.url))}catch(e){console.log("‚ùå Error getting active tab:",e)}}))}isValidHttpUrl(e){try{const t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch{return!1}}trackThirdPartyRequest(a,s,o){console.log("üìä Tracking third-party request:",{sourceDomain:a,trackerDomain:s,requestType:o});let i=this.siteData.get(a);if(!i&&(console.log("‚ùå No site data found for:",a,"- Creating new site data"),this.initializeSiteDataForDomain(a),i=this.siteData.get(a),!i))return void console.log("‚ùå Failed to create site data for:",a);const r=i.trackers.find((e=>e.domain===s));if(r)r.count++,console.log("üìà Updated tracker count:",s,r.count);else{const e=t[s],a={domain:s,count:1,category:e?.category||"unknown",blocked:this.isTrackerBlocked(s)};i.trackers.push(a),console.log("üÜï New tracker detected:",a)}const n=i.trustScore;i.trustScore=e.calculateScore(i.trackers),console.log("üéØ Trust score updated:",n,"‚Üí",i.trustScore),this.updateDataFlow(i,a,s),this.siteData.set(a,i)}isTrackerBlocked(e){return["doubleclick.net","googletagmanager.com","facebook.com/tr"].some((t=>e.includes(t)))}updateDataFlow(e,t,a){if(e.dataFlow.nodes.find((e=>e.id===t))||e.dataFlow.nodes.push({id:t,domain:t,type:"source",position:{x:100,y:100}}),!e.dataFlow.nodes.find((e=>e.id===a))){const t=e.dataFlow.nodes.length;e.dataFlow.nodes.push({id:a,domain:a,type:"tracker",position:{x:200+100*t,y:150}})}e.dataFlow.edges.find((e=>e.from===t&&e.to===a))||e.dataFlow.edges.push({from:t,to:a,dataType:"user_data"})}initializeSiteData(e){const t=this.getDomainFromURL(e);if(t)if(console.log("üè† Initializing site data for:",t),this.siteData.has(t))console.log("‚ôªÔ∏è Site data already exists for:",t);else{const a={url:e,trustScore:100,trackers:[],dataFlow:{nodes:[],edges:[]}};this.siteData.set(t,a),console.log("‚úÖ Site data initialized:",a)}else console.warn("‚ùå Cannot initialize site data for invalid URL:",e)}initializeSiteDataForDomain(e){if(console.log("üè† Initializing site data for domain:",e),this.siteData.has(e))console.log("‚ôªÔ∏è Site data already exists for domain:",e);else{const t={url:`https://${e}`,trustScore:100,trackers:[],dataFlow:{nodes:[],edges:[]}};this.siteData.set(e,t),console.log("‚úÖ Site data initialized for domain:",t)}}async getSiteData(e){const t=this.getDomainFromURL(e);if(!t)return console.warn("‚ùå Cannot get site data for invalid URL:",e),null;this.siteData.has(t)||(console.log("üîÑ Site data not found, initializing for:",t),this.initializeSiteData(e));const a=this.siteData.get(t)||null;return console.log("üìä Getting site data for:",t,"Found:",!!a,"Trackers:",a?.trackers?.length||0),a}async toggleTrackerBlocking(e){e?await chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:["tracker_rules"]}):await chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:["tracker_rules"]})}setupMessageListeners(){chrome.runtime.onMessage.addListener(((e,t,a)=>{switch(console.log("üì® Message received:",e.action,e),e.action){case"getSiteData":return this.getSiteData(e.url).then(a),!0;case"getFingerprintScript":return this.getFingerprintScript(e.apiKey).then(a),!0;case"toggleBlocking":return this.toggleTrackerBlocking(e.enabled).then((()=>{a({success:!0})})),!0;case"analyzePrivacyPolicy":return this.analyzePrivacyPolicy(e.url).then(a),!0;case"privacyPoliciesFound":return this.storePrivacyPolicyUrls(e.currentUrl,e.urls),a({success:!0}),!0;case"debugInfo":const t={trackedDomains:Array.from(this.siteData.keys()),totalSites:this.siteData.size,siteDataSnapshot:Array.from(this.siteData.entries()).map((([e,t])=>({domain:e,trackerCount:t.trackers.length,trustScore:t.trustScore})))};return console.log("üêõ Debug info requested:",t),a(t),!0;case"runFingerprint":return e.tabId?this.handleFingerprinting(e.apiKey,e.tabId).then(a).catch((e=>a({success:!1,error:e.message}))):a({success:!1,error:"No tabId provided in the request."}),!0;case"performOptOut":return this.performComprehensiveOptOut(e.url,e.tabId).then(a).catch((e=>a({success:!1,error:e.message}))),!0}}))}storePrivacyPolicyUrls(e,t){const a=this.getDomainFromURL(e);a?this.privacyPolicyUrls.set(a,t):console.warn("‚ùå Cannot store privacy policy URLs for invalid URL:",e)}async analyzePrivacyPolicy(e){if(!this.getDomainFromURL(e))return console.warn("‚ùå Cannot analyze privacy policy for invalid URL:",e),{error:"Invalid URL provided"};console.log("ü§ñ Starting real-time privacy policy analysis for:",e);try{const t=await this.callBackendAPI("/api/privacy-policy/analyze-enhanced",{url:e});if(t.success)return console.log("‚úÖ Enhanced analysis completed successfully"),this.formatAnalysisResponse(t.data,"enhanced");console.log("‚ö†Ô∏è Enhanced analysis failed, trying standard analysis...");const a=await this.callBackendAPI("/api/privacy-policy/analyze",{url:e,enhanced:!1});return a.success?(console.log("‚úÖ Standard analysis completed successfully"),this.formatAnalysisResponse(a.data,"standard")):(console.log("‚ö†Ô∏è Backend unavailable, using fallback analysis..."),await this.fallbackPrivacyAnalysis(e))}catch(t){return console.error("‚ùå Privacy policy analysis failed:",t),await this.fallbackPrivacyAnalysis(e)}}async callBackendAPI(e,t){try{const a=await fetch(`http://localhost:3000${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);return await a.json()}catch(t){throw console.error(`Backend API call failed for ${e}:`,t),t}}formatAnalysisResponse(e,t){return{score:this.calculateScoreFromSafety(e.safety,e.scores),risks:this.extractRisks(e),summary:e.summary||"Privacy policy analysis completed",dataSharing:this.extractDataSharing(e),recommendations:this.generateRecommendations(e),complianceStatus:this.assessCompliance(e),analysisType:t,keyFindings:e.keyFindings||[],scores:e.scores||{},metadata:e.policyMetadata||{}}}calculateScoreFromSafety(e,t){let a=50;switch(e){case"SAFE":a=85;break;case"RISKY":a=50;break;case"UNSAFE":a=20}if(t){const e=((t.dataCollection||50)+(t.thirdParty||50)+(t.userRights||50)+(t.transparency||50))/4;return Math.round(.6*e+.4*a)}return a}extractRisks(e){const t=[];return"UNSAFE"===e.safety?t.push("High privacy risk detected"):"RISKY"===e.safety&&t.push("Moderate privacy concerns identified"),e.scores&&(e.scores.dataCollection<50&&t.push("Extensive data collection practices"),e.scores.thirdParty<50&&t.push("Significant third-party data sharing"),e.scores.userRights<50&&t.push("Limited user control and rights"),e.scores.transparency<50&&t.push("Unclear or vague privacy policy")),e.keyFindings&&e.keyFindings.forEach((e=>{(e.toLowerCase().includes("concern")||e.toLowerCase().includes("risk")||e.toLowerCase().includes("issue"))&&t.push(e)})),t.length>0?t:["Analysis completed without major concerns"]}extractDataSharing(e){const t=[];return e.keyFindings&&e.keyFindings.forEach((e=>{(e.toLowerCase().includes("google")||e.toLowerCase().includes("facebook")||e.toLowerCase().includes("analytics")||e.toLowerCase().includes("advertising")||e.toLowerCase().includes("third party")||e.toLowerCase().includes("partners"))&&t.push(e)})),0===t.length&&t.push("Analytics services","Advertising networks"),t}generateRecommendations(e){const t=[];return e.scores&&(e.scores.userRights<70&&(t.push("Review your privacy settings"),t.push("Consider opting out of data sharing")),e.scores.transparency<70&&t.push("Read the full privacy policy carefully"),e.scores.thirdParty<60&&(t.push("Use privacy-focused browser settings"),t.push("Consider using tracking protection"))),"UNSAFE"===e.safety&&(t.push("Avoid sharing sensitive information"),t.push("Use alternative services if possible")),t.length>0?t:["Enable privacy protection features"]}assessCompliance(e){const t={gdpr:"unclear",ccpa:"unclear",coppa:"unclear"};if(e.keyFindings){const a=e.keyFindings.join(" ").toLowerCase();(a.includes("gdpr")||a.includes("data protection"))&&(t.gdpr=e.scores?.userRights>70?"compliant":"partial"),(a.includes("ccpa")||a.includes("california"))&&(t.ccpa=e.scores?.userRights>70?"compliant":"partial"),(a.includes("children")||a.includes("coppa"))&&(t.coppa=e.scores?.dataCollection>80?"compliant":"non-compliant")}return t}async fallbackPrivacyAnalysis(e){const t=this.getDomainFromURL(e);if(!t)return{error:"Invalid URL provided"};const a=this.privacyPolicyUrls.get(t)||[];if(0===a.length){const e=["/privacy","/privacy-policy","/privacy.html","/privacy.php","/privacy.aspx","/terms","/terms-of-service","/terms-and-conditions","/legal/privacy","/legal/terms","/help/privacy","/support/privacy","/about/privacy","/policies/privacy","/privacy-statement","/privacy-notice","/data-protection","/cookie-policy","/gdpr","/ccpa"],s=[`https://${t}`,`https://www.${t}`,`http://${t}`,`http://www.${t}`];for(const t of s){for(const s of e)try{const e=new AbortController,o=setTimeout((()=>e.abort()),5e3),i=await fetch(`${t}${s}`,{method:"HEAD",signal:e.signal});if(clearTimeout(o),i.ok){a.push(`${t}${s}`);break}}catch(e){}if(a.length>0)break}}if(0===a.length)return{score:50,risks:["No privacy policy found"],summary:"Unable to locate a privacy policy for this website.",dataSharing:[],recommendations:["Look for privacy information in website footer"],complianceStatus:{gdpr:"unclear",ccpa:"unclear",coppa:"unclear"},analysisType:"fallback"};try{const e=await this.fetchPrivacyPolicyText(a[0]),s=await this.performBasicPrivacyAnalysis(e,t),o=this.siteData.get(t);return o&&(o.privacyAnalysis=s,this.siteData.set(t,o)),s}catch(e){return console.error("Fallback privacy policy analysis failed:",e),{score:30,risks:["Failed to analyze privacy policy"],summary:"Privacy policy analysis encountered an error.",dataSharing:[],recommendations:["Manual review recommended"],complianceStatus:{gdpr:"unclear",ccpa:"unclear",coppa:"unclear"},analysisType:"fallback"}}}async performBasicPrivacyAnalysis(e,t){const a=e.toLowerCase();let s=70;const o=[],i=[];return(a.includes("third party")||a.includes("partners"))&&(s-=10,o.push("Data may be shared with third parties"),i.push("Third-party partners")),(a.includes("cookies")||a.includes("tracking"))&&i.push("Tracking cookies"),(a.includes("advertising")||a.includes("marketing"))&&(s-=5,i.push("Advertising partners")),(a.includes("google analytics")||a.includes("analytics"))&&i.push("Google Analytics"),(a.includes("gdpr")||a.includes("data protection"))&&(s+=10),(a.includes("opt out")||a.includes("opt-out"))&&(s+=5),{score:Math.max(20,Math.min(100,s)),risks:o.length>0?o:["Standard data collection practices"],summary:"Basic privacy policy analysis completed",dataSharing:i.length>0?i:["Standard website analytics"],recommendations:s<50?["Review privacy settings","Consider opt-out options"]:["Standard privacy recommendations"],complianceStatus:{gdpr:"unclear",ccpa:"unclear",coppa:"unclear"},analysisType:"basic"}}async fetchPrivacyPolicyText(e){try{const t=await fetch(e);let a=(await t.text()).replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"");a=a.replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi,"");let s=a.replace(/<[^>]*>/g," ");return s=s.replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'"),s=s.replace(/\s+/g," ").trim(),s}catch(t){throw console.error("Failed to fetch privacy policy:",e,t),new Error(`Failed to fetch privacy policy: ${t instanceof Error?t.message:"Unknown error"}`)}}async performPrivacyAnalysis(e,t){const a=e.toLowerCase(),s=[],o=[];let i=80;const r={"Data Selling":{keywords:["sell","sale","sold","monetize","revenue from data","third-party purchasers"],penalty:25,context:["personal information","user data","your data"]},"Cross-site Tracking":{keywords:["track across","follow you","behavioral tracking","cross-site","cross-platform"],penalty:20,context:["websites","platforms","services"]},"Vague Data Retention":{keywords:["indefinitely","as long as necessary","business purposes","legal requirements"],penalty:15,context:["retain","keep","store","maintain"]},"Limited User Control":{keywords:["cannot delete","unable to remove","permanent","irrevocable"],penalty:20,context:["account","data","information"]},"Broad Data Collection":{keywords:["all information","any data","everything","comprehensive"],penalty:15,context:["collect","gather","obtain"]},"Weak Consent Mechanisms":{keywords:["deemed consent","implied consent","continued use","by using"],penalty:18,context:["agree","consent","acceptance"]},"Data Sharing with Law Enforcement":{keywords:["law enforcement","government agencies","legal process","subpoena"],penalty:10,context:["share","provide","disclose"]},"Location Tracking":{keywords:["precise location","gps","geolocation","whereabouts"],penalty:15,context:["track","collect","monitor"]},"Biometric Data Collection":{keywords:["biometric","fingerprint","facial recognition","voice print"],penalty:20,context:["collect","process","store"]},"Children Data Collection":{keywords:["under 13","children","minors","parental consent"],penalty:25,context:["collect","process","target"]}};for(const[e,t]of Object.entries(r)){const o=t.keywords.some((e=>a.includes(e))),r=t.context.some((e=>a.includes(e)));o&&r&&(s.push(e),i-=t.penalty)}const n={Google:["google","alphabet","youtube","gmail","google analytics","doubleclick"],"Meta/Facebook":["facebook","meta","instagram","whatsapp","messenger"],Amazon:["amazon","aws","amazon web services","alexa"],Microsoft:["microsoft","office 365","azure","bing"],Apple:["apple","icloud","itunes","app store"],"TikTok/ByteDance":["tiktok","bytedance"],"Twitter/X":["twitter","x corp"],"Advertising Networks":["adsense","admob","advertising partners","ad networks"],"Analytics Providers":["analytics","tracking","measurement","statistics"],"Data Brokers":["data broker","information broker","third-party data"],"Marketing Partners":["marketing partners","promotional partners","affiliates"],"Government Agencies":["government","law enforcement","regulatory agencies"]};for(const[e,t]of Object.entries(n))t.some((e=>a.includes(e)))&&!o.includes(e)&&o.push(e);const c=[{keywords:["opt-out","opt out"],bonus:8,description:"Clear opt-out mechanisms"},{keywords:["delete account","data deletion"],bonus:10,description:"Account deletion available"},{keywords:["anonymize","anonymization"],bonus:6,description:"Data anonymization"},{keywords:["encryption","encrypted"],bonus:8,description:"Data encryption"},{keywords:["minimal data","data minimization"],bonus:12,description:"Data minimization principle"},{keywords:["user control","user choice"],bonus:8,description:"User control emphasized"},{keywords:["transparent","transparency"],bonus:6,description:"Transparency commitment"},{keywords:["third-party audits","security audits"],bonus:10,description:"Security auditing"},{keywords:["gdpr","ccpa","privacy rights"],bonus:12,description:"Privacy law compliance"}],l=[];for(const e of c)e.keywords.some((e=>a.includes(e)))&&(i+=e.bonus,l.push(e.description));const d={"Social Media":["social","posts","friends","connections"],"E-commerce":["purchase","shopping","payment","transactions"],Financial:["financial","banking","credit","loan"],Healthcare:["health","medical","patient","treatment"],Education:["student","academic","education","learning"]};let p="General";for(const[e,t]of Object.entries(d))if(t.some((e=>a.includes(e)))){p=e,"Financial"!==e&&"Healthcare"!==e||(i-=5);break}i=Math.max(0,Math.min(100,i));let u=`This ${p.toLowerCase()} privacy policy has been analyzed for comprehensive privacy practices. `;return u+=i>=80?"The policy demonstrates strong privacy protection with clear user rights, limited data sharing, and transparent practices.":i>=60?"The policy shows reasonable privacy practices but has some areas of concern regarding data collection or sharing.":i>=40?"The policy has significant privacy concerns with extensive data collection, sharing, or unclear user rights.":"The policy raises serious privacy concerns with poor user protection, extensive data sharing, or lack of user control.",l.length>0&&(u+=` Positive aspects include: ${l.slice(0,3).join(", ")}.`),{score:i,risks:s.slice(0,8),summary:u,dataSharing:[...new Set(o)].slice(0,8),industryType:p,positiveFeatures:l.slice(0,5),analysisDepth:"Enhanced AI Analysis",lastAnalyzed:(new Date).toISOString()}}async getFingerprintScript(e){const t=`https://fpnpmcdn.net/v3/${e}/loader_v3.11.10.js`;try{const e=await fetch(t);if(!e.ok)throw new Error(`Failed to fetch script: ${e.statusText}`);return{script:await e.text()}}catch(e){return console.error("Failed to fetch FingerprintJS script:",e),{error:e.message}}}async handleFingerprinting(e,t){try{await chrome.scripting.executeScript({target:{tabId:t},files:["fingerprint-agent.js"],world:"MAIN"});const s=await chrome.scripting.executeScript({target:{tabId:t},func:a,args:[e],world:"MAIN"});if(s&&s[0]&&s[0].result)return s[0].result;throw new Error("No result returned from fingerprinting script")}catch(e){return console.error("Background fingerprinting error:",e),{success:!1,error:`Failed to run fingerprinting: ${e.message}`}}}async performComprehensiveOptOut(e,t){try{const t=this.getDomainFromURL(e);if(!t)throw new Error("Invalid URL provided");console.log("üö´ Starting comprehensive opt-out for:",t),await this.addDomainToBlockList(t),this.clearDomainTrackingData(t),await this.enableEnhancedBlockingForDomain(t),this.privacyPolicyUrls.delete(t),await chrome.storage.local.set({[`optedOut_${t}`]:{timestamp:Date.now(),userInitiated:!0,comprehensive:!0}});const a=this.siteData.get(t);return a&&(a.trustScore=95,a.trackers=[],this.siteData.set(t,a)),console.log("‚úÖ Background opt-out processing completed for:",t),{success:!0,message:`Comprehensive opt-out completed for ${t}`}}catch(e){return console.error("‚ùå Background opt-out failed:",e),{success:!1,error:`Opt-out failed: ${e.message}`}}}async addDomainToBlockList(e){try{const t=(await chrome.storage.local.get(["blockedDomains"])).blockedDomains||[];t.includes(e)||(t.push(e),await chrome.storage.local.set({blockedDomains:t}),console.log("üìù Added domain to block list:",e))}catch(e){console.warn("Failed to add domain to block list:",e)}}clearDomainTrackingData(e){try{this.siteData.delete(e),Array.from(this.blockedRequests.keys()).filter((t=>t.includes(e))).forEach((e=>this.blockedRequests.delete(e))),console.log("üßπ Cleared tracking data for:",e)}catch(e){console.warn("Failed to clear domain tracking data:",e)}}async enableEnhancedBlockingForDomain(e){try{const t=[{id:Date.now(),priority:1,action:{type:"block"},condition:{initiatorDomains:[e],resourceTypes:["script","xmlhttprequest","image","media","font","websocket"]}}];(e.includes("youtube.com")||e.includes("google.com"))&&t.push({id:Date.now()+1,priority:2,action:{type:"block"},condition:{urlFilter:"*youtube.com/api/stats*",resourceTypes:["xmlhttprequest"]}},{id:Date.now()+2,priority:2,action:{type:"block"},condition:{urlFilter:"*youtube.com/youtubei/v1/log_event*",resourceTypes:["xmlhttprequest"]}},{id:Date.now()+3,priority:2,action:{type:"block"},condition:{urlFilter:"*youtube.com/ptracking*",resourceTypes:["xmlhttprequest","image"]}}),await chrome.declarativeNetRequest.updateDynamicRules({addRules:t}),console.log("üõ°Ô∏è Enhanced blocking enabled for:",e)}catch(e){console.warn("Failed to enable enhanced blocking:",e)}}}})();